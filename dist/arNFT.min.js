!function(){"use strict";var e=function(e,t,a){this.width=e,this.height=t,this.root=new THREE.Object3D,this.root.matrixAutoUpdate=!1,this.config=a};e.prototype.init=function(e,n){this.cameraPara;var i=this.root;(async function(e,t){return await new Promise((function(t,a){const n=new XMLHttpRequest;n.open("GET",e),n.responseType="json",n.onload=function(){t(n.response)},n.onerror=function(){a("error "+n.status)},n.send(null)}))})(this.config).then((function(o){!function(e){var t=document.createElement("div");t.id="loading";var a=document.createElement("img");a.src=e.loading.logo.src,a.alt=e.loading.logo.alt;var n=document.createElement("span");n.setAttribute("class","loading-text"),n.innerText=e.loading.loadingMessage,t.appendChild(a),t.appendChild(n);document.getElementById("marker");document.body.insertBefore(t,document.body.firstChild)}(o),function(e){if(e){var t=document.createElement("div");t.id="stats",t.className="ui stats";var a=document.createElement("div");a.id="stats1",a.className="stats-item";var n=document.createElement("p");n.className="stats-item-title",n.innerText="Main",a.appendChild(n),t.appendChild(a);var i=document.createElement("div");i.id="stats2",i.className="stats-item";var o=document.createElement("p");o.className="stats-item-title",o.innerText="Worker",i.appendChild(o),t.appendChild(i);var r=document.getElementById("loading");document.body.insertBefore(t,r)}}(n);var r=function(){var e=document.createElement("div");e.id="app";var t=document.createElement("canvas");t.id="canvas";var a=document.createElement("video");a.id="video",a.setAttribute("autoplay",""),a.setAttribute("muted",""),a.setAttribute("playsinline",""),e.appendChild(a),e.appendChild(t);var n=document.getElementById("loading");return document.body.insertBefore(e,n),{container:e,canvas:t,video:a}}(),d=(r.container,r.canvas),s=r.video;if(n){var l=new Stats;l.showPanel(0),document.getElementById("stats1").appendChild(l.dom);var c=new Stats;c.showPanel(0),document.getElementById("stats2").appendChild(c.dom)}if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){var m={audio:!1,video:!0};window.innerWidth<800&&(m={audio:!1,video:{width:{ideal:this.width},height:{ideal:this.height},facingMode:{exact:"environment"}}}),navigator.mediaDevices.getUserMedia(m).then((function(r){s.srcObject=r,s.addEventListener("loadedmetadata",(function(){s.play(),function(e,n,i,o,r,d,s,l,c,m){var u,p,v,f,g,h,w,E,y,x,b,M,T,R=document.createElement("canvas"),k=R.getContext("2d"),C=new THREE.WebGLRenderer({canvas:d,alpha:m.renderer.alpha,antialias:m.renderer.antialias,precision:m.renderer.precision});C.setPixelRatio(window.devicePixelRatio);var N=new THREE.Scene,L=new THREE.Camera;L.matrixAutoUpdate=!1,N.add(L);var A=new THREE.AmbientLight(16777215);N.add(A),N.add(c);var H;function S(){self.onmessage=function(n){var i=n.data;switch(i.type){case"load":return void function(e){var n=self.origin;console.log("base path:",n);var i=n+"/"+e.artoolkitUrl;importScripts(i),self.addEventListener("artoolkitNFT-loaded",(function(){var i=n+"/"+e.camera_para,o=new ARCameraParamNFT(i);o.onload=function(){var i=(t=new ARControllerNFT(e.pw,e.ph,o)).getCameraMatrix();t.addEventListener("getNFTMarker",(function(e){a={type:"found",matrixGL_RH:JSON.stringify(e.data.matrixGL_RH),proj:JSON.stringify(i)}}));var r=n+"/"+e.marker;t.loadNFTMarker(r,(function(e){t.trackNFTMarkerId(e,2),console.log("loadNFTMarker -> ",e),postMessage({type:"endLoading",end:!0})})),postMessage({type:"loaded",proj:JSON.stringify(i)})}}))}(i);case"process":return e=i.imagedata,void function(){a=null,t&&t.process(e);a?postMessage(a):postMessage({type:"not found"});e=null}()}};var e=null,t=null,a=null}var P=function(e){H=e?JSON.parse(e.matrixGL_RH):null},B=Date.now();function I(){k.fillStyle="black",k.fillRect(0,0,y,x),k.drawImage(i,0,0,u,p,b,M,w,E);var e=k.getImageData(0,0,y,x);T.postMessage({type:"process",imagedata:e},[e.data.buffer])}var U=function(){j(),requestAnimationFrame(U)},j=function(){s();var e=Date.now();if(e-B,B=e,H){c.visible=!0;for(var n=0;n<16;n++)t.delta[n]=H[n]-t.interpolated[n],t.interpolated[n]=t.interpolated[n]+t.delta[n]/24;a(c.matrix,t.interpolated)}else c.visible=!1;C.render(N,L)};(function(){u=o,p=r,g=320/Math.max(u,p/3*4),h=/Android|mobile|iPad|iPhone/i.test(navigator.userAgent)?window.outerWidth/o:1,v=u*h,f=p*h,w=u*g,E=p*g,y=Math.max(w,E/3*4),x=Math.max(E,w/4*3),b=(y-w)/2,M=(x-E)/2,R.style.clientWidth=y+"px",R.style.clientHeight=x+"px",R.width=y,R.height=x,C.setSize(v,f);var e=new Blob([S.toString().replace(/^function .+\{?|\}$/g,"")],{type:"text/js-worker"}),t=URL.createObjectURL(e);(T=new Worker(t)).postMessage({type:"load",pw:y,ph:x,camera_para:m.cameraPara,marker:n,artoolkitUrl:m.artoolkitUrl}),T.onmessage=function(e){var t=e.data;switch(t.type){case"loaded":var n=JSON.parse(t.proj),i=y/w,o=x/E;n[0]*=i,n[4]*=i,n[8]*=i,n[12]*=i,n[1]*=o,n[5]*=o,n[9]*=o,n[13]*=o,a(L.projectionMatrix,n);break;case"endLoading":if(1==t.end){var r=document.getElementById("loading");r&&(r.querySelector(".loading-text").innerText="Start the tracking!",setTimeout((function(){r.parentElement.removeChild(r)}),2e3))}break;case"found":P(t);break;case"not found":P(null)}l(),I()}})(),U(),I()}(0,e,s,s.videoWidth,s.videoHeight,d,(function(){n&&l.update()}),(function(){n&&c.update()}),i,o)}))})).catch((function(e){console.log(e.name+": "+e.message)}))}}))},e.prototype.add=function(e){this.root.add(e)},e.prototype.loadModel=function(e,t,a,n,i){var o,r=this.root;(new THREE.GLTFLoader).load(e,(function(e){(o=e.scene).scale.set(i,i,i),o.rotation.x=Math.PI/2,o.position.x=t,o.position.y=a,o.position.z=n,o.matrixAutoUpdate=!1,r.add(o)}))};var t={delta:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],interpolated:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},a=function(e,t){var a=[];for(var n in t)a[n]=t[n];"function"==typeof e.elements.set?e.elements.set(a):e.elements=[].slice.call(a)};window.ARnft=e,window.THREE=THREE}();